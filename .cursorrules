This repository is a SWI-Prolog application (portage-ng).

## How to run (IMPORTANT)
- Do NOT run ad-hoc `swipl -g "..."` snippets; they often miss required operator defs, libraries, and module load order.
- Always launch via the project wrapper (project root):
  - `./Source/Scripts/portage-ng-dev --mode standalone <target>`
  - `./Source/Scripts/portage-ng-dev --mode standalone --shell`
  - Non-interactive / CI-style: `./Source/Scripts/portage-ng-dev --mode standalone --ci <target>`
    Exit codes:
      - 0 = no assumptions
      - 1 = only prover cycle-break assumptions
      - 2 = any domain assumptions (e.g. missing/non-existent deps)

### Preferred scripted workflow (here-doc “piping”)
For quick iteration and for reproducible debugging, prefer running a *scripted* Prolog session via `--shell` and a here-doc:

```sh
./Source/Scripts/portage-ng-dev --mode standalone --shell --time-limit 60 <<'PL'
prover:test_stats(portage).
% Any other queries you want:
% prover:test_stats_pkgs(portage, ['kde-apps'-'kde-apps-meta']).
halt.
PL
```

This keeps the full project load graph intact (same as interactive `--shell`), while letting you run multi-line “scripts” non-interactively.

The canonical load graph for standalone is in `portage-ng.pl`:
- `load_common_modules/0`
- `load_standalone_modules/0`

## Architecture (mental model)
Pipeline (standalone):
- reader/parser build KB facts
- prover builds (ProofAVL, ModelAVL, Constraints, TriggersAVL)
- planner does fast wave planning for acyclic portion and returns a remainder
- scheduler post-processes remainder: SCC (Kosaraju) and merge-sets for :run SCCs
- printer renders plan + warnings

Key files:
- `Source/prover.pl`: inductive proof search; cycles become prover cycle-break assumptions (`assumed(rule(Lit))` in proof, `assumed(Lit)` in model).
- `Source/rules.pl`: domain rules; domain assumptions appear as `rule(assumed(X), [])` and show as “Domain assumptions”.
- `Source/planner.pl`: wave planner; returns (Plan, RemainderRules).
- `Source/scheduler.pl`: SCC/merge-set scheduling for remainder; acts only on :run SCCs.
- `Source/printer.pl`: output + warnings; distinguishes domain assumptions vs prover cycle-breaks.

Assumption taxonomy (do not mix these up):
- Domain assumptions (rules-level): proof key `rule(assumed(X))`
- Prover cycle-break assumptions: proof key `assumed(rule(X))`

## Non-interactive / sandbox robustness
- Terminal size lookups must go through `config:printing_tty_size/2` (direct `tty_size/2` may throw in non-tty environments).
- Do NOT run `--sync` / repository syncing from inside the sandbox. The user will run `--sync` externally when needed.
- Do NOT create `metadata/md5-cache/*` manually. `--sync` (egencache/md5-cache generation) produces those automatically.
- Do NOT run `--graph` / repository graphing from inside the sandbox. The user will run `--graph` externally when needed.

## Performance/engineering notes
- Proof/Model/Triggers are assoc/AVL-based; avoid repeated full traversals when possible.
- Query performance uses `goal_expansion/2` macros in `Source/query.pl`.

