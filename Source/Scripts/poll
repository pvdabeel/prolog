#!/opt/local/bin/bash

shopt -s expand_aliases

# Needs bash 4 or newer (using associative arrays)

if [ ${BASH_VERSINFO[0]} -lt 4 ]; then
    echo "Bash version 4 or newer is required, please upgrade your bash."
    exit 1
fi

# We will be calling portage-ng-dev, which is written in SWI-prolog. Check if it is installed:

if ! command -v swipl &> /dev/null; then
    echo "SWI-prolog is not installed, please install it first."
    exit 1
fi

# Define the alias for portage-ng-dev:

alias portage-ng-dev='swipl -O --stack_limit=256G --table-space=256G --shared-table-space=256G -f /Users/pvdabeel/Desktop/Prolog/portage-ng.pl -p portage=/Users/pvdabeel/Desktop/Prolog -Dverbose_autoload=false -Dreadline=editline -g main --'


# Key locations

PORTNAME="portage"
PORTDIR="/Volumes/Storage/Repository/portage-git"  # no trailing /
GRAPHDIR="/Volumes/Storage/Graph/portage"          # no training /


# -----------------------------------------------------------------------------
# Starting the Poll loop
# -----------------------------------------------------------------------------

while true
do

# Check portage directory

# Check if portage directory exists:
if [ ! -d "${PORTDIR}" ] || [ -z "$(ls -A "${PORTDIR}")" ]; then
    echo "Portage directory '${PORTDIR}' does not exist or is empty, please create it first."
    exit 1
fi


# Change to portage directory:
cd "${PORTDIR}";


# Retrieve portage directory git status

# Check if git is installed:
if ! command -v git &> /dev/null; then
    echo "Git is not installed, please install it first."
    exit 1
fi

git fetch --prune;
LOCAL=$(git rev-parse HEAD);
REMOTE=$(git rev-parse @{u});


# If our local revision id doesn't match the remote, we will need to pull the changes

#if [ $LOCAL != $REMOTE ]; then
if [ true ]; then
     
    # ----------------------------------------------------------------------------
    # Case 1 : Sync needed        
    # ----------------------------------------------------------------------------

    echo -e "\033[1;33m>>> Remote repository with changes : \"${PORTNAME}\" \033[0m"
    echo -e "\033[1;90m--- `date`\033[0m" 
    echo 

    # capture start time
    start_time=$(date +%s)

    # ----------------------------------------------------------------------------
    # 1) Sync repository and update graphs        
    # ----------------------------------------------------------------------------

    portage-ng-dev --mode standalone --sync   # sync repository
    #portage-ng-dev --mode client --save      # save repository - not necessary, we can keep things in memory in client-server mode

    echo -e "\033[92m--- Updating graphs\033[0m"
    portage-ng-dev --mode standalone --graph  # update graph
    

    # ----------------------------------------------------------------------------
    # Case 2 : Remove files for which no ebuild exists  
    # ----------------------------------------------------------------------------
      
    echo -e "\033[92m--- Cleaning orphaned files\033[0m"
    echo

    declare -A has_ebuild         # key: "category/ebuildfile" -> 1 (associative array)  

    # 1) Index all ebuilds once
    while IFS= read -r f; do
        rel=${f#"$PORTDIR"/}      # category/.../pkg-ver.ebuild
        category=${rel%%/*}       # category
        base=${f##*/}             # pkg-ver.ebuild
        has_ebuild["$category/$base"]=1
    done < <(find "$PORTDIR" -mindepth 3 -maxdepth 3 -type f -name '*.ebuild')

    # 2) Now walk all .merge files in the graph directory and check against the map
    find "$GRAPHDIR" -mindepth 2 -maxdepth 2 -type f -name '*.merge' \
    | while IFS= read -r mergefile; do

        rel=${mergefile#"$GRAPHDIR"/}   # category/pkg-ver.merge
        category=${rel%%/*}             # category
        base=${mergefile##*/}           # pkg-ver.merge

        ebuild=${base%.merge}.ebuild    # pkg-ver.ebuild
        relevant=${base%.merge}         # pkg-ver

        if [[ -z ${has_ebuild["$category/$ebuild"]} ]]; then
            echo -e "\033[1;90m% Removing ${GRAPHDIR}/${category}/${relevant} files (no matching ${ebuild} found)"
            rm -f -- "${GRAPHDIR}/${category}/${relevant}".{merge,info,fetchonly,emerge,dot,svg} "${GRAPHDIR}/${category}/${relevant}"-*.{html,dot,svg} 2>/dev/null || true
        fi
    done


    # ----------------------------------------------------------------------------
    # 3) Git add, commit & push changes        
    # ----------------------------------------------------------------------------

    echo  
    echo -e "\033[92m--- Updating git repository\033[0m"

    pushd ${GRAPHDIR}
    git add .
    git commit -m "Update" 
    git push -u origin master 
    popd

    # ----------------------------------------------------------------------------
    # Calculate duration
    # ----------------------------------------------------------------------------

    # Calculate duration
    end_time=$(date +%s)
    duration=$((end_time - start_time))
    
    # Format duration (optional: H:M:S)
    hours=$((duration / 3600))
    minutes=$(( (duration % 3600) / 60 ))
    seconds=$((duration % 60))
    echo
    echo -e "\033[1;33m>>> Done processing changes in repository: \"${PORTNAME}\"\033[0m"
    echo -e "\033[1;90m--- `date`\033[0m" 
    echo -e "\033[1;90m--- Duration: ${hours}:${minutes}:${seconds}\033[0m" 

else 

    echo -e "\033[1;33m>>> Remote repository has no changes... sleeping for 15 minutes\033[0m"
    echo -e "\033[1;90m--- `date`\033[0m" 

fi

sleep 15m
done
