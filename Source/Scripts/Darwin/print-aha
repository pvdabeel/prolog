#!/bin/bash

# Converts terminal output merge, fetchonly, info, and emerge raw ansi files to .html
# and embeds them into SVGs using a consistent colored progress view.


# =============================================================================
#  INITIALISATION
# =============================================================================

set -eo pipefail

if [ -z "${1:-}" ]; then
  echo "Error: Directory argument required"
  exit 1
fi

# Target directory
TARGET_DIR="$1"

# Always defined (empty by default) 
FIND_MODNEWER=()


# =============================================================================
#  CONFIGURATION
# =============================================================================

# -----------------------------------------------------------------------------
# Parallel job count
# -----------------------------------------------------------------------------

JOBS=56


# -----------------------------------------------------------------------------
# Progress bar formats (colored)
# -----------------------------------------------------------------------------


PV_FMT_HTML_MERGE=$'\033[1;90m% [%{progress-amount-only}] - Creating HTML merge  [ %{bar-shaded} | %t | %e ]\033[0m'
PV_FMT_HTML_FETCH=$'\033[1;90m% [%{progress-amount-only}] - Creating HTML fetch  [ %{bar-shaded} | %t | %e ]\033[0m'
PV_FMT_HTML_INFO=$'\033[1;90m% [%{progress-amount-only}] - Creating HTML info   [ %{bar-shaded} | %t | %e ]\033[0m'
PV_FMT_HTML_EMERGE=$'\033[1;90m% [%{progress-amount-only}] - Creating HTML emerge [ %{bar-shaded} | %t | %e ]\033[0m'
PV_FMT_SVG_MERGE=$'\033[1;90m% [%{progress-amount-only}] - Inserting SVG merge  [ %{bar-shaded} | %t | %e ]\033[0m'
PV_FMT_SVG_FETCH=$'\033[1;90m% [%{progress-amount-only}] - Inserting SVG fetch  [ %{bar-shaded} | %t | %e ]\033[0m'
PV_FMT_SVG_INFO=$'\033[1;90m% [%{progress-amount-only}] - Inserting SVG info   [ %{bar-shaded} | %t | %e ]\033[0m'
PV_FMT_SVG_EMERGE=$'\033[1;90m% [%{progress-amount-only}] - Inserting SVG emerge [ %{bar-shaded} | %t | %e ]\033[0m'
PV_FMT_HTML_FIXUP=$'\033[1;90m% [%{progress-amount-only}] - Applying HTML fixes  [ %{bar-shaded} | %t | %e ]\033[0m'

# =============================================================================
# FUNCTIONS
# =============================================================================

# -----------------------------------------------------------------------------
# Funtion: Embed HTML into SVG
# -----------------------------------------------------------------------------

modify_svg() {
  local base_name="$1"
  local svg_file="${base_name}.svg"
  local rel_html="./$(basename "$base_name").html"
  sed -i '' "s|</svg>|<foreignObject x=\"4\" y=\"80\" width=\"1620\" height=\"1020\"><body xmlns=\"http://www.w3.org/1999/xhtml\"><iframe src=\"./${rel_html}\" width=\"1600\" height=\"1000\" style=\"border: 1px solid black;\"></iframe></body></foreignObject></svg>|" ${svg_file}
}

export -f modify_svg


# -----------------------------------------------------------------------------
# Function: Convert raw ASCII colored text files to HTML
# -----------------------------------------------------------------------------

convert_to_html() {
  local ext="$1"
  local format="$2"

  local count
  count=$(find "$TARGET_DIR" -type f -iname "*.${ext}" "${FIND_MODNEWER[@]}" | wc -l)
  (( count == 0 )) && return

  find "$TARGET_DIR" -type f -iname "*.${ext}" "${FIND_MODNEWER[@]}" \
    | pv -l -s "$count" --eta --timer --progress -F "$format" \
    | sed "s/\.${ext}$//" \
    | xargs -P"$JOBS" -n1 -I{} \
      bash -c 'aha -s -c ../.proof.css -t $(basename "$1.$2") -f "$1.$2" > "$1-$2.html"' _ {} "$ext"
}


# -----------------------------------------------------------------------------
# Function: Fixup HTML files
# -----------------------------------------------------------------------------

fixup_html_files() {
  local ext="$1"
  local format="$2"
  local pattern="*-info.html"

  local count
  count=$(find "$TARGET_DIR" -type f -iname "$pattern" "${FIND_MODNEWER[@]}" | wc -l)
  (( count == 0 )) && return

  find "$TARGET_DIR" -type f -iname "$pattern" "${FIND_MODNEWER[@]}" -print0 \
    | pv -0 -s "$count" --eta --timer --progress -F "$format" \
    | xargs -0 -P"$JOBS" -n16 \
        perl -pi'' -e 's/-------<span/-------\n<span/g' || true
}


# -----------------------------------------------------------------------------
# Function: Embed the generated HTML into SVGs iframe
# -----------------------------------------------------------------------------

embed_html_in_svg() {
  local ext="$1"
  local format="$2"

  local count
  count=$(find "$TARGET_DIR" -type f -iname "*-${ext}.svg" "${FIND_MODNEWER[@]}" | wc -l)
  (( count == 0 )) && return

  find "$TARGET_DIR" -type f -iname "*-${ext}.svg" "${FIND_MODNEWER[@]}" \
    | pv -l -s "$count" --eta --timer --progress -F "$format" \
    | sed 's/\.svg$//' \
    | xargs -P"$JOBS" -n1 -I{} \
      bash -c 'modify_svg "$1"' _ {}    
}



# =============================================================================
#  MAIN LOGIC
# =============================================================================

FIND_MODNEWER=()

if [ -f "${TARGET_DIR}/.lastprint" ]; then
  FIND_MODNEWER=(-mnewer "${TARGET_DIR}/.lastprint")
fi

# Convert raw ASCII text files into HTML
convert_to_html   "merge"     "$PV_FMT_HTML_MERGE"  || true
convert_to_html   "fetchonly" "$PV_FMT_HTML_FETCH"  || true
convert_to_html   "info"      "$PV_FMT_HTML_INFO"   || true
convert_to_html   "emerge"    "$PV_FMT_HTML_EMERGE" || true 

# Post-process HTML (minor fixup)
fixup_html_files  "fixup"     "$PV_FMT_HTML_FIXUP"  || true

# Embed the HTML into existing SVG
embed_html_in_svg "merge"     "$PV_FMT_SVG_MERGE"   || true
embed_html_in_svg "fetchonly" "$PV_FMT_SVG_FETCH"   || true 
embed_html_in_svg "info"      "$PV_FMT_SVG_INFO"    || true
embed_html_in_svg "emerge"    "$PV_FMT_SVG_EMERGE"  || true

# Touch timestamp
touch "${TARGET_DIR}/.lastprint"
